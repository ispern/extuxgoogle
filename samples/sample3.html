<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Sample3: Ext.ux.google.map.View / Ext.ux.google.search.*</title>
    <link rel="stylesheet" type="text/css" href="http://extjs.cachefly.net/ext-3.2.1/resources/css/ext-all.css" />
    <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.2.1/adapter/ext/ext-base-debug.js"></script>
    <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.2.1/ext-all-debug.js"> </script>
    <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.2.1/examples/form/combos.css"> </script>
    <script type="text/javascript" src="../Ext.ux.google.Loader.js"></script>

    <script type="text/javascript" src="../search/Ext.ux.google.search.Proxy.js"></script>
    <script type="text/javascript" src="../search/Ext.ux.google.search.Reader.js"></script>
    <script type="text/javascript" src="../search/Ext.ux.google.search.Store.js"></script>

    <script type="text/javascript" src="../map/Ext.ux.google.map.View.js"></script>
    <script type="text/javascript" src="../map/Ext.ux.google.map.Proxy.js"></script>

    <script type="text/javascript">
        Ext.onReady(function () {
            var tpl = new Ext.XTemplate('<h3 class="selector">{title}</h3>');

            var store = new Ext.data.Store({
                proxy: new Ext.ux.google.map.Proxy({}),
                reader: new Ext.data.JsonReader({
                    root: 'data',
                    idProperty: 'id',
                }, [{
                    name: 'id',
                    mapping: 'id'
                },{
                    name: 'address',
                    mapping: 'address'
                },{
                    name: 'lat',
                    mapping: 'lat'
                },{
                    name: 'lng',
                    mapping: 'lng'
                }])
            });

            var gridstore = new Ext.data.JsonStore({
                fields: ['address', 'lat', 'lng']
            });

            var resultTpl = new Ext.XTemplate('<tpl for="."><div class="search-item">', '<h3>住所:{address}</h3>', '経度:{lng} 緯度:{lat}', '</div></tpl>');

            var createMarker = function(record) {
                var gmapview = Ext.getCmp('mpnl');
                gmapview.createMarker(record, gmapview.getConfig(record.id));
                gridstore.add(record);
            };

            new Ext.Viewport({
                layout: 'border',
                items: [{
                    region: 'north',
                    height: 40,
                    split: true,
                    layout: 'table',
                    layoutConfig: {
                        columns: 1,
                        tableAttrs: {
                            style: {
                                margin: '5px 0 0 5px'
                            }
                        }
                    },
                    items: [{
                        xtype: 'combo',
                        store: store,
                        triggerAction: 'all',
                        mode: 'remote',
                        displayField: 'address',
                        valueField: 'id',
                        loadingText: '検索中...',
                        selectOnFocus: true,
                        hiddenName: 'id',
                        enableKeyEvents: true,
                        emptyText: '住所を入力してください',
                        width: 300,
                        hideTrigger: true,
                        tpl: resultTpl,
                        itemSelector: 'div.search-item',
                        minChars: 2,
                        listeners: {
                            specialkey: function(field, e) {
                                if (e.getKey() === e.ENTER) {
                                    createMarker(this.getStore().getById(Ext.get(field.getName()).dom.value));
                                }
                            }
                        }
                    }]
                },{
                    region: 'center',
                    layout: 'border',
                    items: [{
                        region: 'center',
                        items: {
                            xtype: 'gmapview',
                            id: 'mpnl',
                            tpl: tpl,
                            mapConfig: {
                                lat: 35.3162461234567,
                                lng: 139.4199371234567,
                                zoom: 14,
                                geoip: true,
                                googlebar: true
                            },
                            itemSelector: 'h3.selector'
                        }
                    },{
                        region: 'west',
                        width: 400,
                        split: true,
                        xtype: 'grid',
                        viewConfig: {
                            forceFit: true
                        },
                        store: gridstore,
                        columns: [{
                            header: 'Title',
                            dataIndex: 'address'
                        },{
                            header: 'Latitude',
                            dataIndex: 'lat'
                        },{
                            header: 'Longitude',
                            dataIndex: 'lng'
                        }],
                        sm: new Ext.grid.RowSelectionModel({
                            singleSelect: true,
                            listeners: {
                                'rowselect': {
                                    fn: function (t, i, r) {
                                        var map = Ext.getCmp('mpnl');
                                        var mrk = map.getMarkerById(r.id);
                                        map.openInfoWindow(mrk);
                                    }
                                }
                            }
                        }),
                        bbar: new Ext.PagingToolbar({
                            store: store,
                            id: 'ptbar',
                            pageSize: 20
                        })
                    }]
                }]
            });
        });

    </script>
</head>
<body>
</body>
</html>
